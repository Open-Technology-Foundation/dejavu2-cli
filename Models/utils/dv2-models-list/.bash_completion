#!/bin/bash
# Bash completion for dv2-models-list

_dv2_models_list() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Basic options
    opts="--filter -F --or -O --not -N --case-sensitive -C --preset -P
          --alias -a --parent -p --model-category -c --family -f
          --available -v --enabled -e
          --format -o --columns -col --no-header -H --group -g
          --sort -s --reverse -r --limit -l
          --stats -S --count-by -b --unique -u
          --models-file -m --include-disabled -d
          --help -h"

    # Format choices
    local formats="default table json csv yaml tree"
    
    # Preset choices
    local presets="production experimental disabled unavailable vision llm embedding anthropic openai google latest large-context claude gpt o1 free"
    
    # Common model categories
    local categories="LLM embed image tts stt moderation"
    
    # Common parent providers
    local parents="OpenAI Anthropic Google Ollama"
    
    # Common field names for filtering/sorting/grouping
    local fields="model alias parent family model_category enabled available vision context_window max_output_tokens token_costs"
    
    # Filter operators
    local operators="equals not_equals contains not_contains starts_with ends_with regex in not_in exists not_exists"

    case ${prev} in
        --format|-o)
            COMPREPLY=( $(compgen -W "${formats}" -- ${cur}) )
            return 0
            ;;
        --preset|-P)
            COMPREPLY=( $(compgen -W "${presets}" -- ${cur}) )
            return 0
            ;;
        --parent|-p)
            COMPREPLY=( $(compgen -W "${parents}" -- ${cur}) )
            return 0
            ;;
        --model-category|-c)
            COMPREPLY=( $(compgen -W "${categories}" -- ${cur}) )
            return 0
            ;;
        --sort|-s|--group|-g|--count-by|-b|--unique|-u)
            COMPREPLY=( $(compgen -W "${fields}" -- ${cur}) )
            return 0
            ;;
        --columns|-col)
            # Allow comma-separated field names
            local IFS=$','
            local last_field="${cur##*,}"
            local prefix="${cur%${last_field}}"
            COMPREPLY=( $(compgen -W "${fields}" -- ${last_field}) )
            if [[ ${#COMPREPLY[@]} -eq 1 ]]; then
                COMPREPLY[0]="${prefix}${COMPREPLY[0]}"
            fi
            return 0
            ;;
        --filter|-F)
            # For filter expressions, provide basic field:operator: structure
            if [[ ${cur} == *:*:* ]]; then
                # Already has field:operator:, don't complete further
                return 0
            elif [[ ${cur} == *: ]]; then
                # Has field:, complete operators
                COMPREPLY=( $(compgen -W "${operators}" -S ":" -- "${cur##*:}") )
                # Add current prefix back
                local prefix="${cur%:*}:"
                COMPREPLY=( "${COMPREPLY[@]/#/${prefix}}" )
                return 0
            elif [[ ${cur} == *:* ]]; then
                # Has field:operator, add colon
                COMPREPLY=( "${cur}:" )
                return 0
            else
                # Complete field names
                COMPREPLY=( $(compgen -W "${fields}" -S ":" -- ${cur}) )
                return 0
            fi
            ;;
        --models-file|-m)
            # Complete file paths
            COMPREPLY=( $(compgen -f -- ${cur}) )
            return 0
            ;;
        --available|-v|--enabled|-e|--limit|-l)
            # Numeric values, don't complete
            return 0
            ;;
        --alias|-a|--family|-f)
            # String values, don't complete
            return 0
            ;;
    esac

    # Handle special cases where we might want field completion
    if [[ ${cur} == *:* ]] && [[ ${prev} != --filter && ${prev} != -F ]]; then
        # Could be part of a field:value pair for quick options
        return 0
    fi

    # Default to completing available options
    COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
    return 0
}

# Register the completion function
complete -F _dv2_models_list dv2-models-list
complete -F _dv2_models_list dv2-models-list.py